frappe.ready(function () {
    let complianceData = [];
    let changesList = [];
    let users = [];
    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'Compliancetracker',
            fields: ['*'],
        },
        callback: function (response) {
            if (response.message) {
                complianceData = response.message;
                const complianceNames = complianceData.map(item => item.name);
                populateTableWithComplianceNames(complianceNames,complianceData,changesList,users);
            }
        },
    });

    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'User',
            fields: ['full_name'],
        },
        callback: function (response) {
            if (response.message) {
		const  users = response.message;
                const userNames = response.message.map(item => item.full_name);
                populateDropdownsInTable(userNames);
            }
        },
    });

    const saveButton = document.querySelector('#saveButton');
    saveButton.addEventListener('click', function () {
        const payload = createPayload();
        makePostRequest(payload);
    });
});

function populateTableWithComplianceNames(complianceNames,complianceData,changesList,userList) {
    const tableBody = document.querySelector('#complianceTable tbody');
    complianceNames.forEach(name => {
        const row = tableBody.insertRow();
        const cell1 = row.insertCell(0);
        cell1.textContent = name;
        const cell2 = row.insertCell(1);
        const userDropdown = createUserDropdown();
        cell2.appendChild(userDropdown);
        userDropdown.addEventListener('change', function () {
            trackChanges(name, userDropdown.value, complianceData,changesList,userList);
        });
    });
}

function createUserDropdown() {
    const dropdown = document.createElement('select');
    dropdown.className = 'form-control';
    return dropdown;
}

function populateDropdownsInTable(userNames) {
    const dropdowns = document.querySelectorAll('#complianceTable select');
    dropdowns.forEach(dropdown => {
        userNames.forEach(userName => {
            const option = document.createElement('option');
            option.value = userName;
            option.textContent = userName;
            dropdown.appendChild(option);
        });
    });
}

function trackChanges(complianceName, selectedUser, complianceData,changesList,userList) {
    const compliance = complianceData.find(item => item.name === complianceName);
    const selectedUserObj =  userList.find(item.full_name === selectedUser);
    const  payLoad = makePayload(compliance,selectedUserObj);
}

function makePostRequest(payload) {
    frappe.call({
        method: '',
	type:'POST',
        args: {
            payload: payload,
        },
        callback: function (response) {
            if (response.message) {
                console.log(response.message)
            }
        },
    });
}

function createPayload() {
    return {};
}
